#!/bin/sh -x


#
# Setup user for debug
#
echo 'goapp:x:2000:2000:goapp,,,:/home/goapp:/bin/bash' >> /etc/passwd
echo 'goapp:goapp' |chpasswd
echo "goapp:x:2000:goapp" >> /etc/group
echo "%goapp  ALL=(ALL:ALL) ALL" >> /etc/sudoers


#
# Setup sshd for debug
#
sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
sudo systemctl enable ssh
sudo systemctl restart ssh


# Disable cloud-* services
# systemctl disable cloud-config
# systemctl disable cloud-final
# systemctl disable cloud-init-local
# systemctl disable cloud-init
for service in `systemctl list-unit-files -t service | grep cloud- | awk '{print $1}'`
do
    systemctl disable $service
done


#
# Setup init service
#
mkdir -p /opt/goapp
mkdir -p /opt/goapp/bin/

cat << 'EOS' > /opt/goapp/bin/goapp-init
#!/bin/sh -x
# Setup Network
{{- range $i, $port := .Ports }}

dev{{ $i }}=`grep {{ $port.VmMac }} /sys/class/net/*/address -l | awk -F '/' '{print $5}'`
ip addr add {{ $port.VmIp }}/32 dev $dev{{ $i }}
ip link set $dev{{ $i }} up

{{- end }}

ip route add {{ .DefaultGateway }} dev $dev0
ip route add default via {{ .DefaultGateway }}
EOS

chmod 755 /opt/goapp/bin/goapp-init

# Create init service
cat << 'EOS' > /etc/systemd/system/goapp-init.service
[Unit]
Description=Initial cloud-init job (metadata service crawler)
DefaultDependencies=no
After=cloud-init-local.service
After=systemd-networkd-wait-online.service
After=networking.service
Before=network-online.target
Before=sshd-keygen.service
Before=sshd.service
Before=sysinit.target
Before=systemd-user-sessions.service

[Service]
Type=oneshot
ExecStart=/opt/goapp/bin/goapp-init
RemainAfterExit=yes
TimeoutSec=0

# Output needs to appear in instance console output
StandardOutput=journal+console

[Install]
WantedBy=multi-user.target
EOS

sudo systemctl daemon-reload
sudo systemctl enable goapp-init
sudo systemctl start goapp-init


# ------------------------------
# Setup resolver
# ------------------------------
mkdir -p /etc/systemd/resolved.conf.d/
cat << 'EOS' > /etc/systemd/resolved.conf.d/goapp.conf
{{- range $i, $resolver := .Resolvers }}
[Resolve]
DNS={{ $resolver.Resolver }}
# FallbackDNS=
# Domains=
LLMNR=no
MulticastDNS=no
DNSSEC=no
Cache=yes
DNSStubListener=yes
{{- end }}
EOS
systemctl enable systemd-resolved
systemctl restart systemd-resolved
